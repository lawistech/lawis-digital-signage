import{a as l}from"./chunk-WBRTOA2C.js";import{$ as k,A as _,Cb as O,Na as m,R as P,X as B,Za as F,ab as U,bb as I,cb as V,eb as x,ha as g,ia as f,j as w,jb as s,kb as d,l as E,lb as N,mb as R,mc as $,na as M,nb as b,o as v,ob as C,tb as j,ub as u,wb as T}from"./chunk-URYE4ZYK.js";import{a as y,b as D,i as h}from"./chunk-ODN5LVDJ.js";var z=(()=>{class a{constructor(){this.BUCKET_NAME="media",this.TABLE_NAME="media",this.MAX_FILE_SIZE=100*1024*1024}uploadMedia(e,t){return h(this,null,function*(){try{if(e.size>this.MAX_FILE_SIZE)throw new Error("File size exceeds 100MB limit");let i=e.name.split(".").pop(),r=`${Date.now()}-${Math.random().toString(36).substring(7)}.${i}`,o=`${t.type}/${r}`,{data:n,error:p}=yield l.storage.from(this.BUCKET_NAME).upload(o,e,{cacheControl:"3600",upsert:!1});if(p)throw p;let c="";if(t.type==="video"){c=yield this.generateVideoThumbnail(e);let A=`thumbnails/${r.replace(/\.[^/.]+$/,"")}.jpg`,{error:L}=yield l.storage.from(this.BUCKET_NAME).upload(A,this.dataURItoBlob(c));if(L)throw L;c=l.storage.from(this.BUCKET_NAME).getPublicUrl(A).data.publicUrl}let{data:{publicUrl:Z}}=l.storage.from(this.BUCKET_NAME).getPublicUrl(o),q={name:t.name,description:t.description,type:t.type,url:Z,thumbnail_url:c||void 0,duration:t.type==="video"?yield this.getVideoDuration(e).catch(()=>{}):void 0,metadata:y({size:e.size,format:e.type,lastModified:new Date(e.lastModified).toISOString()},t.metadata||{}),tags:t.tags||[]},{data:W,error:S}=yield l.from(this.TABLE_NAME).insert([q]).select().single();if(S)throw S;return{media:W,thumbnailUrl:c}}catch(i){throw console.error("Upload error:",i),i}})}getMedia(e){let t=l.from(this.TABLE_NAME).select("*");return e&&(e.type?.length&&(t=t.in("type",e.type)),e.tags?.length&&(t=t.contains("tags",e.tags)),e.search&&(t=t.or(`name.ilike.%${e.search}%,description.ilike.%${e.search}%`)),e.startDate&&(t=t.gte("created_at",e.startDate)),e.endDate&&(t=t.lte("created_at",e.endDate))),w(t.order("created_at",{ascending:!1})).pipe(v(({data:i,error:r})=>{if(r)throw r;return i}),_(i=>(console.error("Error fetching media:",i),E(()=>i))))}getMediaById(e){return w(l.from(this.TABLE_NAME).select("*").eq("id",e).single()).pipe(v(({data:t,error:i})=>{if(i)throw i;return t}),_(t=>(console.error("Error fetching media:",t),E(()=>t))))}updateMedia(e,t){return w(l.from(this.TABLE_NAME).update(D(y({},t),{updated_at:new Date().toISOString()})).eq("id",e).select().single()).pipe(v(({data:i,error:r})=>{if(r)throw r;return i}),_(i=>(console.error("Error updating media:",i),E(()=>i))))}deleteMedia(e){return h(this,null,function*(){try{let{data:t,error:i}=yield l.from(this.TABLE_NAME).select("*").eq("id",e).single();if(i)throw i;let r=this.getPathFromUrl(t.url),{error:o}=yield l.storage.from(this.BUCKET_NAME).remove([r]);if(o)throw o;if(t.thumbnail_url){let p=this.getPathFromUrl(t.thumbnail_url);yield l.storage.from(this.BUCKET_NAME).remove([p])}let{error:n}=yield l.from(this.TABLE_NAME).delete().eq("id",e);if(n)throw n}catch(t){throw console.error("Error deleting media:",t),t}})}generateVideoThumbnail(e){return h(this,null,function*(){return new Promise((t,i)=>{let r=document.createElement("video"),o=document.createElement("canvas"),n=o.getContext("2d");if(!n){i(new Error("Could not get canvas context"));return}r.onloadedmetadata=()=>{o.width=r.videoWidth,o.height=r.videoHeight;let c=r.duration*.25;r.currentTime=Math.min(1,c||0)},r.onseeked=()=>{try{n.drawImage(r,0,0,o.width,o.height);let c=o.toDataURL("image/jpeg",.8);URL.revokeObjectURL(r.src),t(c)}catch(c){i(new Error("Error generating thumbnail: "+c))}},r.onerror=()=>{URL.revokeObjectURL(r.src),i(new Error("Error loading video"))};let p=URL.createObjectURL(e);r.src=p,r.load()})})}getVideoDuration(e){return h(this,null,function*(){return new Promise((t,i)=>{let r=document.createElement("video");r.onloadedmetadata=()=>{let n=Math.round(r.duration);URL.revokeObjectURL(r.src),t(n)},r.onerror=()=>{URL.revokeObjectURL(r.src),i(new Error("Error getting video duration"))};let o=URL.createObjectURL(e);r.src=o,r.load()})})}dataURItoBlob(e){let t=atob(e.split(",")[1]),i=e.split(",")[0].split(":")[1].split(";")[0],r=new ArrayBuffer(t.length),o=new Uint8Array(r);for(let n=0;n<t.length;n++)o[n]=t.charCodeAt(n);return new Blob([r],{type:i})}getPathFromUrl(e){let t=l.storage.from(this.BUCKET_NAME).getPublicUrl("").data.publicUrl;return decodeURIComponent(e.replace(t,""))}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=P({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();function H(a,K){if(a&1&&(s(0,"div",15)(1,"div",17)(2,"span"),u(3,"Uploading..."),d(),s(4,"span"),u(5),d()(),s(6,"div",18),N(7,"div",19),d()()),a&2){let e=C();m(5),T("",e.uploadProgress,"%"),m(2),I("width",e.uploadProgress,"%")}}function G(a,K){if(a&1&&(s(0,"div",16),u(1),d()),a&2){let e=C();m(),T(" ",e.error," ")}}var ae=(()=>{class a{constructor(){this.uploadComplete=new M,this.cancel=new M,this.mediaService=B(z),this.uploadProgress=0,this.isUploading=!1,this.error=null}onDragOver(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.add("border-blue-400")}onDragLeave(e){e.currentTarget.classList.remove("border-blue-400")}onDrop(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.remove("border-blue-400");let i=e.dataTransfer?.files;i&&this.handleFiles(Array.from(i))}onFileSelected(e){let t=e.target;t.files&&this.handleFiles(Array.from(t.files))}handleFiles(e){return h(this,null,function*(){if(!e.length)return;this.isUploading=!0,this.error=null;let t=[],i=e.length;try{for(let[r,o]of e.entries()){if(!o.type.startsWith("image/")&&!o.type.startsWith("video/"))throw new Error(`File ${o.name} is not a supported media type`);let n={name:o.name.split(".")[0],type:o.type.startsWith("image/")?"image":"video",description:`Uploaded ${o.type.startsWith("image/")?"image":"video"} file`,metadata:{size:o.size,format:o.type,lastModified:new Date(o.lastModified).toISOString()}};try{let p=yield this.mediaService.uploadMedia(o,n);t.push(p.media),this.uploadProgress=Math.round((r+1)/i*100)}catch(p){throw console.error(`Error uploading ${o.name}:`,p),new Error(`Failed to upload ${o.name}`)}}this.uploadProgress=100,setTimeout(()=>{this.uploadComplete.emit(t),this.resetUpload()},500)}catch(r){console.error("Upload error:",r),this.error=r instanceof Error?r.message:"Failed to upload files",this.isUploading=!1}})}resetUpload(){this.uploadProgress=0,this.isUploading=!1,this.error=null}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275cmp=k({type:a,selectors:[["app-media-upload"]],outputs:{uploadComplete:"uploadComplete",cancel:"cancel"},standalone:!0,features:[O],decls:23,vars:7,consts:[["fileInput",""],[1,"fixed","inset-0","bg-black/30","backdrop-blur-sm","flex","items-center","justify-center","z-50"],[1,"bg-white","rounded-xl","shadow-2xl","max-w-2xl","w-full","mx-4"],[1,"p-6","border-b"],[1,"flex","justify-between","items-center"],[1,"text-xl","font-semibold"],[1,"text-gray-400","hover:text-gray-600",3,"click","disabled"],[1,"material-icons"],[1,"p-6"],[1,"border-2","border-dashed","border-gray-200","rounded-xl","p-8","text-center","transition-colors","duration-200",3,"dragover","dragleave","drop"],[1,"material-icons","text-4xl","text-gray-400","mb-2"],[1,"text-lg","font-medium","mb-1"],[1,"text-sm","text-gray-500","mb-4"],["type","file","multiple","","accept","image/*,video/*",1,"hidden",3,"change","disabled"],[1,"px-4","py-2","bg-blue-50","text-blue-600","rounded-lg","hover:bg-blue-100","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"mt-4"],[1,"mt-4","p-4","bg-red-50","text-red-600","rounded-lg"],[1,"flex","justify-between","text-sm","mb-1"],[1,"w-full","bg-gray-200","rounded-full","h-2"],[1,"bg-blue-600","h-2","rounded-full","transition-all","duration-300"]],template:function(t,i){if(t&1){let r=R();s(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"h2",5),u(5,"Upload Media"),d(),s(6,"button",6),b("click",function(){return g(r),f(i.cancel.emit())}),s(7,"span",7),u(8,"close"),d()()()(),s(9,"div",8)(10,"div",9),b("dragover",function(n){return g(r),f(i.onDragOver(n))})("dragleave",function(n){return g(r),f(i.onDragLeave(n))})("drop",function(n){return g(r),f(i.onDrop(n))}),s(11,"span",10),u(12,"cloud_upload"),d(),s(13,"h3",11),u(14,"Drag and drop files here"),d(),s(15,"p",12),u(16,"or"),d(),s(17,"input",13,0),b("change",function(n){return g(r),f(i.onFileSelected(n))}),d(),s(19,"button",14),b("click",function(){g(r);let n=j(18);return f(n.click())}),u(20," Browse Files "),d()(),F(21,H,8,3,"div",15)(22,G,2,1,"div",16),d()()()}t&2&&(m(6),U("disabled",i.isUploading),m(4),V("opacity-50",i.isUploading),m(7),U("disabled",i.isUploading),m(2),U("disabled",i.isUploading),m(2),x(i.uploadProgress>0?21:-1),m(),x(i.error?22:-1))},dependencies:[$],styles:[".material-icons[_ngcontent-%COMP%]{font-family:Material Icons;font-weight:400;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased}"]})}}return a})();export{z as a,ae as b};
